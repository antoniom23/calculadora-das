<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora DAS - Simples Nacional | ECCONOMIZE</title>
    <meta name="description" content="Calculadora profissional de DAS do Simples Nacional. Processa XMLs de NF-e automaticamente.">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                        <rect width="40" height="40" rx="12" fill="url(#gradient1)"/>
                        <path d="M12 20L18 26L28 14" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <defs>
                            <linearGradient id="gradient1" x1="0" y1="0" x2="40" y2="40">
                                <stop offset="0%" stop-color="#667eea"/>
                                <stop offset="100%" stop-color="#764ba2"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <div>
                        <h1>ECCONOMIZE</h1>
                        <p>Calculadora DAS Profissional</p>
                    </div>
                </div>
                <div class="header-badge">
                    <span class="badge">✓ Conforme Receita Federal</span>
                </div>
            </div>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <div class="hero-text">
                    <h2 class="hero-title">Calcule seu <span class="highlight">DAS</span> em segundos</h2>
                    <p class="hero-subtitle">Processe seus XMLs de NF-e automaticamente e obtenha o cálculo preciso do seu DAS conforme a legislação vigente do Simples Nacional.</p>
                    <div class="hero-features">
                        <div class="feature-item">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                            <span>100% Automático</span>
                        </div>
                        <div class="feature-item">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                            <span>Resultados Instantâneos</span>
                        </div>
                        <div class="feature-item">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            <span>100% Seguro</span>
                        </div>
                    </div>
                </div>
                <div class="hero-image">
                    <div class="calculator-preview">
                        <div class="preview-card">
                            <div class="preview-header"><div class="preview-dots"><span></span><span></span><span></span></div></div>
                            <div class="preview-content">
                                <div class="preview-line"></div>
                                <div class="preview-line short"></div>
                                <div class="preview-chart">
                                    <div class="chart-bar" style="height: 60%"></div>
                                    <div class="chart-bar" style="height: 85%"></div>
                                    <div class="chart-bar" style="height: 45%"></div>
                                    <div class="chart-bar" style="height: 70%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="calculator-section">
        <div class="container">
            <form id="calculatorForm" class="calculator-form">
                <div class="form-step active" data-step="1">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div>
                            <h3>Enviar XMLs das Notas Fiscais</h3>
                            <p>Arraste ou clique para selecionar arquivos XML ou ZIP</p>
                        </div>
                    </div>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="xmlFiles" name="xmls" multiple accept=".xml,.zip" hidden>
                        <div class="upload-content">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <h4>Arraste os arquivos aqui</h4>
                            <p>ou clique para selecionar</p>
                            <span class="upload-hint">Aceita arquivos .XML e .ZIP (até 100MB)</span>
                        </div>
                        <div class="upload-files-list" id="filesList"></div>
                    </div>
                </div>

                <div class="form-step" data-step="2">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div>
                            <h3>Informações do Cálculo</h3>
                            <p>Preencha os dados necessários para o cálculo</p>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="rbt12">RBT12 (Receita últimos 12 meses) <span class="tooltip" data-tooltip="Receita Bruta Total acumulada nos últimos 12 meses">?</span></label>
                            <div class="input-with-prefix">
                                <span class="prefix">R$</span>
                                <input type="text" id="rbt12" name="rbt12" placeholder="0,00" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="anexo">Anexo do Simples Nacional <span class="tooltip" data-tooltip="Escolha o anexo conforme sua atividade">?</span></label>
                            <select id="anexo" name="anexo" required>
                                <option value="ANEXO_I">Anexo I - Comércio</option>
                                <option value="ANEXO_II">Anexo II - Indústria</option>
                                <option value="ANEXO_III">Anexo III - Serviços (Locação)</option>
                                <option value="ANEXO_IV">Anexo IV - Serviços (Construção)</option>
                                <option value="ANEXO_V">Anexo V - Serviços (TI/Consultoria)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mes">Mês de Referência</label>
                            <select id="mes" name="mes" required>
                                <option value="01">Janeiro</option><option value="02">Fevereiro</option>
                                <option value="03">Março</option><option value="04">Abril</option>
                                <option value="05">Maio</option><option value="06">Junho</option>
                                <option value="07">Julho</option><option value="08">Agosto</option>
                                <option value="09">Setembro</option><option value="10">Outubro</option>
                                <option value="11">Novembro</option><option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ano">Ano de Referência</label>
                            <input type="number" id="ano" name="ano" min="2018" max="2030" value="2026" required>
                        </div>
                    </div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display:none;">← Anterior</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">Próximo →</button>
                    <button type="submit" class="btn btn-success" id="calculateBtn" style="display:none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        Calcular DAS
                    </button>
                </div>
            </form>

            <div class="loading-state" id="loadingState" style="display:none;">
                <div class="loading-spinner"></div>
                <h3>Processando XMLs...</h3>
                <p>Aguarde enquanto calculamos seu DAS</p>
            </div>

            <!-- RESULTADOS -->
            <div class="results-section" id="resultsSection" style="display:none;">

                <!-- Cabeçalho de resultados -->
                <div class="results-header">
                    <h2>Resultado do Cálculo</h2>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;">
                        <button class="btn btn-secondary" id="newCalculation">Nova Consulta</button>
                        <button class="btn btn-primary" id="downloadPdf" style="display:inline-flex;align-items:center;gap:8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Baixar PDF
                        </button>
                        <button class="btn btn-secondary" id="downloadTxt" style="display:inline-flex;align-items:center;gap:8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg>
                            Baixar TXT
                        </button>
                    </div>
                </div>

                <!-- Identificação do Contribuinte -->
                <div id="contribuinteCard" style="display:none;background:var(--gray-50,#f9fafb);border:1px solid #e5e7eb;border-radius:12px;padding:16px 20px;margin-bottom:20px;">
                    <div style="font-size:11px;font-weight:600;color:#888;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">Identificação do Contribuinte</div>
                    <div style="font-size:15px;font-weight:700;color:#1a1a2e;" id="razaoSocialDisplay"></div>
                    <div style="font-size:13px;color:#555;margin-top:2px;">CNPJ: <span id="cnpjDisplay"></span></div>
                </div>

                <!-- Stats -->
                <div class="stats-grid" id="statsGrid"></div>

                <!-- DAS principal -->
                <div class="result-card main-result">
                    <div class="result-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                    </div>
                    <div class="result-content">
                        <h3>Valor do DAS a Recolher</h3>
                        <div class="result-value" id="dasValue">R$ 0,00</div>
                        <div class="result-details">
                            <span>Alíquota Efetiva: <strong id="aliquotaValue">0%</strong></span>
                            <span>Período: <strong id="periodoValue">-</strong></span>
                        </div>
                    </div>
                </div>

                <!-- Detalhamento -->
                <div class="breakdown-section">
                    <h3>Detalhamento do Cálculo</h3>
                    <div class="breakdown-cards">
                        <div class="breakdown-card">
                            <div class="breakdown-label">Faturamento Bruto</div>
                            <div class="breakdown-value positive" id="faturamentoBruto">R$ 0,00</div>
                        </div>
                        <div class="breakdown-card">
                            <div class="breakdown-label">Deduções</div>
                            <div class="breakdown-value negative" id="deducoesValue">R$ 0,00</div>
                        </div>
                        <div class="breakdown-card">
                            <div class="breakdown-label">Receita Bruta</div>
                            <div class="breakdown-value primary" id="receitaBruta">R$ 0,00</div>
                        </div>
                    </div>
                </div>

                <!-- Notas por Série — logo abaixo do detalhamento -->
                <div class="cfops-section" id="seriesSection" style="display:none;">
                    <h3>Notas por Série</h3>
                    <div class="table-responsive">
                        <table class="cfops-table">
                            <thead>
                                <tr>
                                    <th>Série</th>
                                    <th>Quantidade</th>
                                    <th>Primeira NF</th>
                                    <th>Data</th>
                                    <th>Última NF</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody id="seriesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- CFOPs -->
                <div class="cfops-section">
                    <h3>Resumo por CFOP</h3>
                    <div class="table-responsive">
                        <table class="cfops-table">
                            <thead><tr><th>CFOP</th><th>Tipo</th><th>Quantidade</th><th>Valor Total</th></tr></thead>
                            <tbody id="cfopsTableBody"></tbody>
                        </table>
                    </div>
                </div>

            </div><!-- /results-section -->
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <p><strong>Base Legal:</strong> Lei Complementar nº 123/2006 e Resolução CGSN nº 140/2018</p>
                    <p class="footer-disclaimer">⚠️ Este é um cálculo estimativo. Consulte seu contador para validação final.</p>
                </div>
                <div class="footer-links"><p>© 2026 ECCONOMIZE - Calculadora DAS</p></div>
            </div>
        </div>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('calculatorForm');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('xmlFiles');
        const filesList = document.getElementById('filesList');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const calculateBtn = document.getElementById('calculateBtn');
        const loadingState = document.getElementById('loadingState');
        const resultsSection = document.getElementById('resultsSection');
        const newCalculationBtn = document.getElementById('newCalculation');

        let currentStep = 1;
        let uploadedFiles = [];
        let ultimoResultado = null;

        // ---- UPLOAD ----
        uploadArea.addEventListener('click', (e) => {
            if (e.target.closest('.file-remove')) return;
            fileInput.click();
        });
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', (e) => { if (!uploadArea.contains(e.relatedTarget)) uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); e.target.value = ''; });

        function handleFiles(files) {
            const newFiles = Array.from(files).filter(f =>
                (f.name.endsWith('.xml') || f.name.endsWith('.zip')) &&
                !uploadedFiles.some(u => u.name === f.name && u.size === f.size)
            );
            uploadedFiles = [...uploadedFiles, ...newFiles];
            renderFilesList();
            nextBtn.disabled = uploadedFiles.length === 0;
        }

        function renderFilesList() {
            if (uploadedFiles.length === 0) { filesList.classList.remove('active'); filesList.innerHTML = ''; return; }
            filesList.classList.add('active');
            filesList.innerHTML = uploadedFiles.map((file, i) => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight:600;font-size:14px">${file.name}</div>
                            <div style="font-size:12px;color:var(--gray-500)">${formatSize(file.size)}</div>
                        </div>
                    </div>
                    <button type="button" class="file-remove" data-index="${i}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>`).join('');
            filesList.querySelectorAll('.file-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    uploadedFiles.splice(parseInt(btn.dataset.index), 1);
                    renderFilesList();
                    nextBtn.disabled = uploadedFiles.length === 0;
                });
            });
        }

        function formatSize(b) {
            if (b < 1024) return b + ' B';
            if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
            return (b/1048576).toFixed(1) + ' MB';
        }

        // ---- NAVEGAÇÃO ----
        nextBtn.disabled = true;
        nextBtn.addEventListener('click', () => {
            if (uploadedFiles.length === 0) { alert('Selecione ao menos um arquivo XML ou ZIP'); return; }
            currentStep = 2; updateStep();
        });
        prevBtn.addEventListener('click', () => { currentStep = 1; updateStep(); });

        function updateStep() {
            document.querySelectorAll('.form-step').forEach((s, i) => s.classList.toggle('active', i + 1 === currentStep));
            prevBtn.style.display = currentStep === 1 ? 'none' : 'inline-flex';
            nextBtn.style.display = currentStep === 2 ? 'none' : 'inline-flex';
            calculateBtn.style.display = currentStep === 2 ? 'inline-flex' : 'none';
        }

        // ---- MÁSCARA RBT12 ----
        const rbt12Input = document.getElementById('rbt12');
        rbt12Input.addEventListener('input', (e) => {
            let digits = e.target.value.replace(/\D/g, '');
            if (!digits) { e.target.value = ''; return; }
            let num = parseInt(digits, 10);
            let reais = Math.floor(num / 100);
            let cents = num % 100;
            e.target.value = reais.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ',' + String(cents).padStart(2, '0');
        });

        const now = new Date();
        document.getElementById('mes').value = String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('ano').value = now.getFullYear();

        // ---- SUBMIT ----
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const rbt12Raw = rbt12Input.value.replace(/\./g, '').replace(',', '.');
            if (!rbt12Raw || parseFloat(rbt12Raw) <= 0) { alert('Informe um RBT12 válido'); return; }
            const formData = new FormData();
            uploadedFiles.forEach(f => formData.append('xmls', f));
            formData.append('rbt12', rbt12Raw);
            formData.append('anexo', document.getElementById('anexo').value);
            formData.append('mes', document.getElementById('mes').value);
            formData.append('ano', document.getElementById('ano').value);
            form.style.display = 'none';
            loadingState.style.display = 'block';
            try {
                const response = await fetch('/calcular', { method: 'POST', body: formData });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Erro ao processar');
                ultimoResultado = result;
                displayResults(result);
                loadingState.style.display = 'none';
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (err) {
                alert('Erro ao calcular: ' + err.message);
                loadingState.style.display = 'none';
                form.style.display = 'block';
            }
        });

        // ---- RESULTADOS ----
        function displayResults(data) {
            // Contribuinte
            const contribuinteCard = document.getElementById('contribuinteCard');
            if (data.razao_social || data.cnpj_formatted) {
                document.getElementById('razaoSocialDisplay').textContent = data.razao_social || '';
                document.getElementById('cnpjDisplay').textContent = data.cnpj_formatted || '';
                contribuinteCard.style.display = 'block';
            } else {
                contribuinteCard.style.display = 'none';
            }

            // Stats
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><div class="stat-label">Total de XMLs</div><div class="stat-value">${data.stats.total_arquivos}</div></div>
                <div class="stat-card"><div class="stat-label">Notas Válidas</div><div class="stat-value">${data.stats.notas_validas}</div></div>
                <div class="stat-card"><div class="stat-label">Canceladas</div><div class="stat-value">${data.stats.canceladas}</div></div>
                <div class="stat-card"><div class="stat-label">Duplicadas</div><div class="stat-value">${data.stats.duplicadas}</div></div>`;

            // DAS
            document.getElementById('dasValue').textContent = `R$ ${data.valor_das_formatted}`;
            document.getElementById('aliquotaValue').textContent = `${data.aliquota_efetiva.toFixed(4)}%`;
            document.getElementById('periodoValue').textContent = data.periodo;

            // Detalhamento
            document.getElementById('faturamentoBruto').textContent = `R$ ${data.faturamento_bruto_formatted}`;
            document.getElementById('deducoesValue').textContent = `R$ ${data.deducoes_formatted}`;
            document.getElementById('receitaBruta').textContent = `R$ ${data.receita_bruta_formatted}`;

            // Séries
            const seriesSection = document.getElementById('seriesSection');
            const seriesBody = document.getElementById('seriesTableBody');
            const series = data.series || {};
            if (Object.keys(series).length > 0) {
                seriesSection.style.display = 'block';
                seriesBody.innerHTML = Object.entries(series)
                    .sort(([a],[b]) => a.localeCompare(b))
                    .map(([serie, info]) => `
                        <tr>
                            <td><strong>${serie}</strong></td>
                            <td>${info.quantidade}</td>
                            <td>${info.primeira_numero}</td>
                            <td>${info.primeira_data}</td>
                            <td>${info.ultima_numero}</td>
                            <td>${info.ultima_data}</td>
                        </tr>`).join('');
            } else {
                seriesSection.style.display = 'none';
            }

            // CFOPs
            document.getElementById('cfopsTableBody').innerHTML = Object.entries(data.cfops)
                .map(([cfop, d]) => `
                    <tr>
                        <td><strong>${cfop}</strong></td>
                        <td><span class="type-badge ${d.tipo.toLowerCase()}">${d.tipo}</span></td>
                        <td>${d.quantidade}</td>
                        <td><strong>R$ ${d.valor_formatted}</strong></td>
                    </tr>`).join('');
        }

        // ---- DOWNLOAD PDF ----
        document.getElementById('downloadPdf').addEventListener('click', async () => {
            if (!ultimoResultado) return;
            const btn = document.getElementById('downloadPdf');
            try {
                btn.textContent = 'Gerando...';
                btn.disabled = true;
                const response = await fetch('/gerar-pdf', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(ultimoResultado)
                });
                if (!response.ok) throw new Error('Erro ao gerar PDF');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'DAS_' + (ultimoResultado.periodo || 'resultado').replace('/', '-') + '.pdf';
                a.click();
                URL.revokeObjectURL(url);
            } catch (err) {
                alert('Erro ao gerar PDF: ' + err.message);
            } finally {
                btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Baixar PDF';
                btn.disabled = false;
            }
        });

        // ---- DOWNLOAD TXT ----
        document.getElementById('downloadTxt').addEventListener('click', async () => {
            if (!ultimoResultado) return;
            const btn = document.getElementById('downloadTxt');
            try {
                btn.textContent = 'Gerando...';
                btn.disabled = true;
                const response = await fetch('/gerar-txt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(ultimoResultado)
                });
                if (!response.ok) throw new Error('Erro ao gerar TXT');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'DAS_' + (ultimoResultado.periodo || 'resultado').replace('/', '-') + '.txt';
                a.click();
                URL.revokeObjectURL(url);
            } catch (err) {
                alert('Erro ao gerar TXT: ' + err.message);
            } finally {
                btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg> Baixar TXT';
                btn.disabled = false;
            }
        });

        // ---- NOVA CONSULTA ----
        newCalculationBtn.addEventListener('click', () => {
            currentStep = 1;
            uploadedFiles = [];
            ultimoResultado = null;
            form.reset();
            renderFilesList();
            updateStep();
            nextBtn.disabled = true;
            resultsSection.style.display = 'none';
            form.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const d = new Date();
            document.getElementById('mes').value = String(d.getMonth() + 1).padStart(2, '0');
            document.getElementById('ano').value = d.getFullYear();
        });
    });
    </script>
</body>
</html>
